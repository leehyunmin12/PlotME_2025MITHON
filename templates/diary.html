<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>일기 작성 - Plot!Me</title>
    <!-- Tailwind CSS CDN 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
        }
        /* Modal Overlay CSS */
        .modal-overlay {
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center p-4 sm:p-6">
    <!-- max-w-md로 중앙 컨테이너 크기 제한 및 자동 중앙 정렬 -->
    <div class="w-full max-w-sm sm:max-w-md flex flex-col gap-8">
        
        <!-- Header Section -->
        <header class="py-2">
            <h1 class="text-2xl font-extrabold text-violet-800">Plot!Me 일기 분석기</h1>
            <p class="text-sm text-gray-500">오늘의 감정을 기록하고 AI 분석을 요청하세요.</p>
        </header>

        <!-- Diary Input Form -->
        <div class="bg-white rounded-xl p-6 shadow-xl border border-gray-100">
            <form id="diary-form" onsubmit="submitDiary(event)" class="space-y-4">
                
                <!-- Title Input -->
                <div>
                    <label for="title" class="block text-sm font-medium text-gray-700 mb-1">제목</label>
                    <input type="text" id="title" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-violet-500 focus:border-violet-500 transition duration-150"
                           placeholder="오늘의 하루를 한 줄로 표현해 보세요">
                </div>

                <!-- Content Textarea -->
                <div>
                    <label for="content" class="block text-sm font-medium text-gray-700 mb-1">일기 내용</label>
                    <textarea id="content" rows="8" required
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-violet-500 focus:border-violet-500 transition duration-150"
                              placeholder="오늘 있었던 일, 느꼈던 감정들을 솔직하게 적어주세요."></textarea>
                </div>
                
                <!-- Tags Input -->
                <div>
                    <label for="tags" class="block text-sm font-medium text-gray-700 mb-1">태그 (쉼표로 구분, 선택 사항)</label>
                    <input type="text" id="tags"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-violet-500 focus:border-violet-500 transition duration-150"
                           placeholder="#기쁨, #회사, #친구">
                </div>
                
                <!-- Submit Button -->
                <button type="submit" id="submit-button"
                        class="w-full flex items-center justify-center space-x-2 px-4 py-3 bg-violet-600 text-white font-semibold rounded-xl shadow-lg hover:bg-violet-700 transition duration-300 ease-in-out disabled:bg-violet-400">
                    <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>AI 분석 요청</span>
                </button>
            </form>
        </div>
        
        <!-- AI Summary Result Display (새로 추가) -->
        <div id="summary-result" class="bg-white p-6 rounded-xl border border-gray-100 hidden shadow-xl transition duration-300 ease-in-out">
            <h2 class="text-xl font-bold text-violet-700 mb-3 flex items-center">
                <svg class="w-6 h-6 mr-2 text-violet-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2h8a2 2 0 012 2v10a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3.707 5.707a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 12.586V7a1 1 0 10-2 0v5.586l-1.293-1.293z" clip-rule="evenodd"></path></svg>
                ✨ AI 분석 결과 요약
            </h2>
            <div id="ai-summary-content" class="text-gray-700 text-base leading-relaxed whitespace-pre-wrap">
                AI 분석이 완료되면 요약 내용이 여기에 표시됩니다.
            </div>
            <p id="ai-emotion" class="text-sm text-gray-500 mt-3 font-medium">감정: 분석 전</p>
        </div>
        
    </div>

    <!-- Modal HTML Structure -->
    <div id="custom-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl w-11/12 max-w-xs shadow-2xl text-center">
            <div id="modal-message" class="text-gray-800 text-sm mb-5 leading-relaxed whitespace-pre-wrap"></div>
            <div id="modal-buttons" class="flex justify-center space-x-3">
                <!-- Buttons inserted by JS -->
            </div>
        </div>
    </div>

    <script>
        // 모달 관련 유틸리티 함수
        const modalOverlay = document.getElementById('custom-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalButtons = document.getElementById('modal-buttons');

        function showModal({ message }) {
            modalMessage.textContent = message;
            modalButtons.innerHTML = '';
            
            const closeAndReset = () => {
                modalOverlay.classList.remove('active');
                modalOverlay.classList.add('hidden');
                modalButtons.innerHTML = '';
            };

            modalOverlay.classList.remove('hidden');
            setTimeout(() => modalOverlay.classList.add('active'), 10); // Transition start

            const closeButton = document.createElement('button');
            closeButton.className = 'px-4 py-2 rounded-lg text-sm font-semibold bg-violet-600 text-white hover:bg-violet-700 transition duration-150';
            closeButton.textContent = '확인';
            closeButton.onclick = closeAndReset;
            modalButtons.appendChild(closeButton);
        }

        const maxRetries = 3;
        const initialDelay = 1000; // 1 second

        async function fetchWithRetry(url, options, retries = 0) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    // API에서 500 오류가 발생했지만, 응답 본문에 JSON 오류 메시지가 있을 수 있습니다.
                    const errorText = await response.text();
                    try {
                        const errorJson = JSON.parse(errorText);
                        throw new Error(`API Error: ${errorJson.detail || 'Unknown server error'}`);
                    } catch {
                        throw new Error(`HTTP error! status: ${response.status} - ${errorText.substring(0, 100)}...`);
                    }
                }
                return response;
            } catch (error) {
                if (retries < maxRetries) {
                    const delay = initialDelay * Math.pow(2, retries);
                    console.warn(`API call failed. Retrying in ${delay / 1000}s... (Attempt ${retries + 1}/${maxRetries + 1})`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retries + 1);
                } else {
                    throw error;
                }
            }
        }
        
        async function submitDiary(event) {
            event.preventDefault();

            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            const tagsInput = document.getElementById('tags').value;
            const tags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
            
            const submitButton = document.getElementById('submit-button');
            const loadingSpinner = document.getElementById('loading-spinner');
            const summaryResultDiv = document.getElementById('summary-result');
            const aiSummaryContentDiv = document.getElementById('ai-summary-content');
            const aiEmotionP = document.getElementById('ai-emotion');

            // 분석 전 상태 초기화
            summaryResultDiv.classList.add('hidden');
            
            // 1. 로딩 상태 설정
            submitButton.disabled = true;
            loadingSpinner.classList.remove('hidden');
            submitButton.querySelector('span').textContent = 'AI 분석 중...';

            const diaryData = { title, content, tags };
            
            // API 서버 URL (FastAPI 기본 포트 8000 사용)
            const API_URL = 'http://127.0.0.1:8000/api/summarize-diary';

            try {
                console.log('Sending diary data for analysis...');
                
                const response = await fetchWithRetry(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(diaryData)
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    console.log('Analysis successful. Displaying result and preparing for redirection.');

                    // --- 1. AI 분석 결과를 현재 페이지에 표시 ---
                    const emotionDisplay = result.emotion ? `감정: ${result.emotion}` : '감정: 분석 완료';
                    aiSummaryContentDiv.textContent = result.summary || '요약 내용을 가져오지 못했습니다.';
                    aiEmotionP.textContent = emotionDisplay;
                    summaryResultDiv.classList.remove('hidden'); // 결과 박스 표시
                    
                    // 2. 분석 결과와 원본 일기 내용을 Session Storage에 임시 저장 (index.html 용)
                    sessionStorage.setItem('diaryAnalysisResult', JSON.stringify(result));
                    sessionStorage.setItem('originalDiaryEntry', JSON.stringify(diaryData));
                    
                    // 3. 3초 카운트다운 시작
                    let countdown = 3;
                    loadingSpinner.classList.add('hidden'); // 스피너 숨김
                    submitButton.classList.remove('bg-violet-600', 'hover:bg-violet-700');
                    submitButton.classList.add('bg-green-600', 'hover:bg-green-700');
                    submitButton.querySelector('span').textContent = `결과 화면으로 이동 준비 (${countdown}초)`;

                    const interval = setInterval(() => {
                        countdown -= 1;
                        if (countdown > 0) {
                            submitButton.querySelector('span').textContent = `결과 화면으로 이동 준비 (${countdown}초)`;
                        } else {
                            clearInterval(interval);
                            // 4. 버튼 텍스트 변경 및 클릭 핸들러 추가
                            submitButton.disabled = false;
                            submitButton.querySelector('span').textContent = '결과 화면으로 이동하기';
                            
                            // 폼 제출 방지 이벤트 리스너 제거 및 리디렉션 함수로 대체
                            submitButton.type = 'button';
                            submitButton.onclick = () => {
                                window.location.href = 'index.html';
                            };
                        }
                    }, 1000);

                } else {
                    showModal({ 
                        message: `AI 분석 실패: ${result.summary}` 
                    });
                }
                
            } catch (error) {
                console.error('API 호출 중 오류 발생:', error);
                showModal({ 
                    message: `AI 서버와 통신할 수 없습니다.\n\n오류: ${error.message}\n\nmain.py가 실행 중인지 확인하고, API 키를 설정했는지 확인해주세요.`
                });
            } finally {
                // 오류 발생 시에만 버튼 상태 복구 (성공 시에는 카운트다운 로직이 처리)
                if (submitButton.type === 'submit') { 
                    submitButton.disabled = false;
                    loadingSpinner.classList.add('hidden');
                    submitButton.querySelector('span').textContent = 'AI 분석 요청';
                }
            }
        }

        // 페이지 로드 시 필요한 설정 (선택 사항)
        window.onload = function() {
            console.log('일기 작성 페이지 로드 완료.');
        };

    </script>
</body>
</html>
